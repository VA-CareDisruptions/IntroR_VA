---
title: "Intro to R"
output: html_document
date: '2022-11-22'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(lubridate)
library(table1)
library(tidyr)
```

## Organization

1.  Create an R Project (File/New Project). The home directory is the one where the .Rproj file is saved
2.  Create a folder called Data where you store your Data, create a folder called 'R' where you store R scripts
3.  Create an Rmarkdown (.Rmd) file to organize and annotate your analyses: File/New File/R Markdown. Save this in your home directory. Note you can view your Rmd file formatted in 'visual' style, similar to a MS Word document, or in Source format. The is toggled with a button in upper left corner
4.  Determine which packages you will need and laod them in the first chunk of the Rmarkdown using library(). Commonly used packages include **dplyr** (for data management), **ggplot2** (for plotting), and **lubridate** (for handling date formatting)

## Read in data

We can use 'relative paths' when you are working in an Rproject. The home directory (denoted with a .) is where the .rproj file is. Here we refer to a file in the Data subdirectory. rds is an r data format

```{r}
d1 <- readRDS('./Data/mortality_1percent.rds')
```

You could save this as a .csv file if you need to export for other purposes

```{r}
write.csv(d1, './Data/mortality_1percent.csv')
```

You can even read in files directly from the web. For example, this reads in the csv file from Github

```{r, eval=F}
test1 <- read.csv('https://github.com/VA-CareDisruptions/IntroR_VA/blob/main/Data/mortality_1percent.csv?raw=true')
```

## Viewing your data

You can always view a spreadsheet with your data using 'View()'

```{r}
View(d1)
```

Or if you just want a preview, use 'head'

```{r}
head(d1)
```

You can also extract info about number of rows and columns

```{r}
nrow(d1)
ncol(d1)
```

## Exploring your data

First, check the format of the variables in your data frame. 'chr' is a character variable, 'num' or' int' or 'dbl' are numeric variables; factor is a categorical variable.

```{r}
str(d1)


```

Let's format a date variable using the month and year as inputs

Here we are going to use **pipes** to work with the data. a Pipe is denoted with a %\>%. It is saying that we want to create a new data frame called 'd2'. We are starting with data frame d1 and then adding onto it (mutating). We could also just overwrite d1 with the updated dataframe by writing d1 \<- d1 %\>%...

Creating dates is complicated. We first paste together the year and month columns from the data frame and append an '01', separating each with a '-'. paste(year, month, '01', sep='-') This then has the format YYYY-MM-DD. But this is a character variable..we have to declare the variable as a Date and tell R what the format is as.Date(x, '%Y-%m-%d')) %Y is 4 digit year (%y would be 2 digit year), %m is 2 digit month (%b would be 3 character month abbreviation), and %d for 2 digit day.

```{r}
d2 <- d1 %>%
  mutate(monthdate = as.Date(paste(year, month, '01', sep='-'), '%Y-%m-%d'))
```

We can see here that the variable was created correctly

```{r}
str(d2)
```

We can get some summary stats easily using the Table1 package

```{r}
table1(~agey + race_recode + sex, data=d2)
```

We can spot a few issues here. first, age has a large range. That is because missing values are stored as 999. We should replace this with NA. age race_recode and sex should be stored as factor variables because they represent categories

```{r}
d2 <- d1 %>%
  mutate(monthdate = as.Date(paste(year, month, '01', sep='-'), '%Y-%m-%d'),
         race_recode= factor(race_recode, levels=c(1,2,3,4,5), c('White','Black','Hispanic','American Indian', 'Asian/Pacific Islanders')) ,
         sex= as.factor(sex),
         agey = if_else(agey>120,NA_real_, agey)
         )
```

```{r}
table1(~agey + race_recode + sex, data=d2)
```

### Make some plots

```{r}
ggplot(d2, aes(x=agey)) + 
  geom_histogram(binwidth=1) +
  theme_classic()+ #makes it look pretty
    xlab('Age (years)')+ #x axis label
   ggtitle('Age Distribution of Deaths')

```

## Let's create some time series

First let's try all-cause deaths, by age group.

1.  Create a variable denoting age category (agec)
2.  Group the dataframe by agec and monthdate (group_by(agec, monthdate))
3.  Count the number of rows in each group
4.  Make sure all combinations of agec and monthdate are represented (filled time series)
5.  Ungroup the dataset

```{r}
d3 <- d2 %>%
  mutate(agec = if_else( agey>=0 & agey<5,1,
                    if_else(agey>=5 & agey<18,2,
                             if_else(agey>=18 & agey<65,3,
                                      if_else(agey>=65 & agey<80,4,
                                               if_else(agey>=80 & agey<120,5,999
                            ))))),
         agec=as.factor(agec)
         ) %>%
  group_by(agec, monthdate) %>%
  summarize(N_deaths = n()) %>% # Step 3
  tidyr::complete(agec, monthdate, fill=list(N_deaths=0)) %>% # Step 4
  ungroup() %>%#Step 5
  filter(!is.na(agec)) #if agec is missing, remove


```

Check your work--we should have same number of rows per group

```{r}
d3 %>% 
  group_by(agec) %>% 
  summarize(N_dates=n())
```

### Make some plots

This looks terrible...this is because we haven't told R how to group the data

```{r}
ggplot(d3, aes(x=monthdate, y=N_deaths)) +
  geom_line()


```

```{r}
ggplot(d3, aes(x=monthdate, y=N_deaths, group=agec, color=agec)) +
  geom_line()
```

Use a theme to make it look nicer

```{r}
ggplot(d3, aes(x=monthdate, y=N_deaths, group=agec, color=agec)) +
  geom_line() +
  theme_classic()
```

Facet wrap to separate out by column. 'free_y' allows each panel to have its own y axis

```{r}
ggplot(d3, aes(x=monthdate, y=N_deaths, group=agec, color=agec)) +
  geom_line() +
  theme_classic() +
  facet_wrap(~agec, scales='free_y')
```

To force the Y axis to 0, set ylim(0,NA), this means bottom must be 0, top goes to whatever max of the data is for that group.

```{r}
ggplot(d3, aes(x=monthdate, y=N_deaths, group=agec, color=agec)) +
  geom_line() +
  theme_classic() +
  facet_wrap(~agec, scales='free_y')+
  ylim(0, NA)
```

## Operations with R

You can use R like a regular calculator

```{r}
1+1
```

```{r}

```
